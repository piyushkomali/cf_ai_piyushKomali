<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Collaborative Shopping List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in {
      animation: slideIn 0.2s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <header class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-3">
        üõí AI Collaborative Shopping List
      </h1>
      <p class="text-gray-400 text-lg">
        Add items naturally or let AI help you plan your meals
      </p>
      <div id="connectionStatus" class="mt-4 inline-block px-4 py-2 rounded-full text-sm font-medium bg-gray-800">
        <span class="inline-block w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></span>
        Connecting...
      </div>
    </header>

    <div class="grid md:grid-cols-2 gap-8">
      <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700">
        <h2 class="text-2xl font-semibold mb-4 flex items-center">
          <span class="mr-2">üí¨</span>
          Add Items
        </h2>
        
        <div class="mb-4 p-4 bg-gray-900 rounded-lg border border-gray-700">
          <p class="text-sm text-gray-400 mb-2">Try these commands:</p>
          <ul class="text-sm text-gray-300 space-y-1">
            <li>‚Ä¢ <span class="text-blue-400 font-mono">add milk</span> - Add a single item</li>
            <li>‚Ä¢ <span class="text-purple-400 font-mono">I am making Mexican food tonight, give me some items for tacos</span> - AI extracts ingredients</li>
            <li>‚Ä¢ <span class="text-green-400 font-mono">Ingredients to make hummus</span> - AI suggests items</li>
          </ul>
        </div>

        <form id="commandForm" class="space-y-4">
          <div>
            <textarea 
              id="commandInput" 
              placeholder="Type a command or describe what you're cooking..."
              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-100 placeholder-gray-500 resize-none"
              rows="3"
            ></textarea>
          </div>
          
          <button 
            type="submit"
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg"
          >
            <span id="sendButtonText">Send</span>
            <span id="sendButtonLoading" class="hidden">
              <svg class="animate-spin inline-block w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Processing...
            </span>
          </button>
        </form>

        <div id="aiStatus" class="mt-4 hidden p-3 rounded-lg"></div>
      </div>

      <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold flex items-center">
            <span class="mr-2">üìù</span>
            Current List
            <span id="itemCount" class="ml-3 text-sm font-normal text-gray-400">(0 items)</span>
          </h2>
          <button 
            id="clearButton"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors duration-200"
          >
            Clear All
          </button>
        </div>

        <div class="bg-gray-900 rounded-lg border border-gray-700 min-h-[400px] max-h-[500px] overflow-y-auto p-4">
          <ul id="shoppingList" class="space-y-2">
            <li class="text-center text-gray-500 py-8" id="emptyState">
              No items yet. Start adding items to your list!
            </li>
          </ul>
        </div>
      </div>
    </div>

    <footer class="mt-12 text-center text-gray-500 text-sm">
      <p>Powered by Cloudflare Workers AI, Durable Objects, and Pages</p>
    </footer>
  </div>

  <script>
    let socket = null;
    let isProcessing = false;

    const commandForm = document.getElementById('commandForm');
    const commandInput = document.getElementById('commandInput');
    const shoppingList = document.getElementById('shoppingList');
    const clearButton = document.getElementById('clearButton');
    const connectionStatus = document.getElementById('connectionStatus');
    const itemCount = document.getElementById('itemCount');
    const emptyState = document.getElementById('emptyState');
    const aiStatus = document.getElementById('aiStatus');
    const sendButtonText = document.getElementById('sendButtonText');
    const sendButtonLoading = document.getElementById('sendButtonLoading');

    function connectWebSocket() {
      const wsUrl = location.origin.replace(/^http/, 'ws') + '/ws';
      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        console.log('Connected to shopping list');
        connectionStatus.innerHTML = `
          <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
          Connected
        `;
        connectionStatus.className = 'mt-4 inline-block px-4 py-2 rounded-full text-sm font-medium bg-green-900 text-green-200';
      };

      socket.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          
          if (message.type === 'updatedList') {
            renderList(message.data);
          } else if (message.type === 'error') {
            showAIStatus(message.message, 'error');
          }
        } catch (err) {
          console.error('Error parsing message:', err);
        }
      };

      socket.onclose = () => {
        console.log('Disconnected. Retrying...');
        connectionStatus.innerHTML = `
          <span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2"></span>
          Disconnected
        `;
        connectionStatus.className = 'mt-4 inline-block px-4 py-2 rounded-full text-sm font-medium bg-red-900 text-red-200';
        
        setTimeout(connectWebSocket, 1000);
      };

      socket.onerror = (err) => {
        console.error('WebSocket error:', err);
      };
    }

    function renderList(items) {
      shoppingList.innerHTML = '';
      
      if (!items || items.length === 0) {
        emptyState.classList.remove('hidden');
        shoppingList.appendChild(emptyState);
        itemCount.textContent = '(0 items)';
        return;
      }

      emptyState.classList.add('hidden');
      itemCount.textContent = `(${items.length} item${items.length !== 1 ? 's' : ''})`;

      items.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-800 px-4 py-3 rounded-lg hover:bg-gray-750 transition-colors slide-in border border-gray-700';
        li.style.animationDelay = `${index * 0.05}s`;
        
        li.innerHTML = `
          <span class="text-gray-100 flex-1">${escapeHtml(item)}</span>
          <button 
            class="ml-4 text-red-400 hover:text-red-300 hover:bg-red-900/30 px-3 py-1 rounded transition-colors"
            onclick="removeItem('${escapeHtml(item)}')"
          >
            ‚úï
          </button>
        `;
        
        shoppingList.appendChild(li);
      });
    }

    function removeItem(item) {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          action: 'removeItem',
          payload: item
        }));
      }
    }

    async function sendMessage(command) {
      if (!command || !command.trim()) return;
      
      const trimmedCommand = command.trim().toLowerCase();

      if (trimmedCommand.startsWith('add ')) {
        const item = command.substring(4).trim();
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            action: 'addItem',
            payload: item
          }));
          showAIStatus(`Added "${item}"`, 'success');
        }
        return;
      }

      if (trimmedCommand.startsWith('remove ')) {
        const item = command.substring(7).trim();
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            action: 'removeItem',
            payload: item
          }));
          showAIStatus(`Removed "${item}"`, 'success');
        }
        return;
      }

      try {
        setLoading(true);
        showAIStatus('ü§ñ AI is processing your request...', 'info');

        const response = await fetch('/process-command', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ command })
        });

        const result = await response.json();

        if (result.success && result.itemsAdded > 0) {
          showAIStatus(`‚úÖ Added ${result.itemsAdded} item${result.itemsAdded !== 1 ? 's' : ''}: ${result.items.join(', ')}`, 'success');
        } else if (result.success && result.itemsAdded === 0) {
          showAIStatus('‚ö†Ô∏è No items found in your request. Try being more specific!', 'warning');
        } else {
          showAIStatus('‚ùå Failed to process command', 'error');
        }
      } catch (err) {
        console.error('Error sending AI command:', err);
        showAIStatus('‚ùå Error processing command', 'error');
      } finally {
        setLoading(false);
      }
    }

    function showAIStatus(message, type) {
      const colors = {
        success: 'bg-green-900 text-green-200 border-green-700',
        error: 'bg-red-900 text-red-200 border-red-700',
        info: 'bg-blue-900 text-blue-200 border-blue-700',
        warning: 'bg-yellow-900 text-yellow-200 border-yellow-700'
      };

      aiStatus.textContent = message;
      aiStatus.className = `mt-4 p-3 rounded-lg border ${colors[type] || colors.info} fade-in`;
      aiStatus.classList.remove('hidden');

      if (type === 'success') {
        setTimeout(() => {
          aiStatus.classList.add('hidden');
        }, 5000);
      }
    }

    function setLoading(loading) {
      isProcessing = loading;
      if (loading) {
        sendButtonText.classList.add('hidden');
        sendButtonLoading.classList.remove('hidden');
        commandInput.disabled = true;
      } else {
        sendButtonText.classList.remove('hidden');
        sendButtonLoading.classList.add('hidden');
        commandInput.disabled = false;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    commandForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (isProcessing) return;
      
      const command = commandInput.value;
      sendMessage(command);
      commandInput.value = '';
    });

    commandInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!isProcessing) {
          commandForm.dispatchEvent(new Event('submit'));
        }
      }
    });

    clearButton.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear the entire list?')) {
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            action: 'clearList'
          }));
          showAIStatus('List cleared', 'info');
        }
      }
    });

    connectWebSocket();
  </script>
</body>
</html>

